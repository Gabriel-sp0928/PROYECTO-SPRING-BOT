<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">
<head>
    <title>Venta - Formulario</title>
</head>
<body>
<div layout:fragment="content">
    <h1 class="text-2xl font-bold mb-4" id="title">Nueva consulta</h1>

    <div class="bg-white shadow rounded-md p-6 max-w-lg">
        <form id="saleForm" class="grid grid-cols-1 gap-4">
            <input id="id" type="hidden" />
            <div>
                <label class="block text-sm font-medium">ID Cotizaci√≥n</label>
                <input id="quoteId" class="mt-1 block w-full border px-3 py-2" />
            </div>
            <div>
                <label class="block text-sm font-medium">Fecha</label>
                <input id="date" type="datetime-local" class="mt-1 block w-full border px-3 py-2" />
            </div>
            <div>
                <label class="block text-sm font-medium">Total</label>
                <input id="total" type="number" step="0.01" class="mt-1 block w-full border px-3 py-2" />
            </div>
            <div>
                <button class="bg-gafraBlue text-white px-4 py-2 rounded">Guardar</button>
                <a href="/sales" class="ml-3">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<script>
    function idFromPath(){
        const m = window.location.pathname.match(/\/sales\/(\d+)\/edit/);
        return m ? m[1] : null;
    }

    async function loadSale(id){
        const res = await fetch('/api/sales/' + id);
        if(!res.ok) return;
        const s = await res.json();
        document.getElementById('id').value = s.id;
        document.getElementById('quoteId').value = s.quote ? s.quote.id : '';
        // set date (if missing, default to now)
        const dateEl = document.getElementById('date');
        if(s.date){ dateEl.value = new Date(s.date).toISOString().slice(0,16); }
        else { dateEl.value = new Date().toISOString().slice(0,16); }
        document.getElementById('total').value = s.total || '';
        document.getElementById('title').textContent = 'Editar consulta #' + s.id;
    }

    document.getElementById('saleForm').addEventListener('submit', async function(e){
        e.preventDefault();
        const id = document.getElementById('id').value;
        const payload = {
            quote: { id: Number(document.getElementById('quoteId').value) },
            total: Number(document.getElementById('total').value)
        };
        if(id){
            await fetch('/api/sales/' + id, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        } else {
            await fetch('/api/sales', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        }
        window.location.href = '/sales';
    });

    (function(){
        const id = idFromPath();
        const dateEl = document.getElementById('date');
        if(id) loadSale(id);
        else if(dateEl){ dateEl.value = new Date().toISOString().slice(0,16); }
    })();
</script>

<!-- Page logic moved to /js/pages.js -->

</body>
</html>
